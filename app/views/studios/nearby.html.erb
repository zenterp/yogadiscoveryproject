<% content_for :header_text do %>
  <a href='/studios/new' style='float:right;text-align:right;font-size:150%'>+</a>
  <span style='float:left;padding-left:0.5em;'>Yoga Discovery Project</span>
<% end %>

  <div style="position:relative;background:none;opacity:0.9;height:450px;padding:0px;" class="well">
  
      <table class="table">
        <tbody></tbody>
      </table>
</div>

<script type='text/template' id="studioRowTemplate">
  <tr class='studioRow'>
    <td class='studioName' style='padding:1.3em;'>
      <p><a href='/{{= id }}'>{{= name }}</a> <small>({{= classes_today_count }})</small></p>
    </td>
    <td style='background-color:#f5f5f5;padding:1.3em;'>{{= distance }} miles</td>
  </tr>
</script>

<script>

  var studioRowTemplate = _.template($("#studioRowTemplate").html());
  function foundLocation(position) {
    getStudios(position, function (studios) {
      $('tbody').html('');
      $tbody = $("<div/>");
      for (i in studios) {
        studio = studios[i];
        obj = {
          name: studio.name.substring(0,19),
          id: studio.id,
          distance: Math.round(studio.distance * 100) / 100,
          classes_today_count: studio.yoga_classes.length
        }
        $row = $(studioRowTemplate(obj));
        $tbody.append($row);
      }
      $('tbody').html($tbody.html());
    })
  }

  function getStudios(position, callback) {
    url = '/api/yoga_classes/nearby.json?lat='+position.coords.latitude+'&lng='+position.coords.longitude;
    $.getJSON('http://yoganow-api.herokuapp.com'+url, function(data) {
      callback(data.yoga_classes);
    })
  }

  function noLocation() {
    alert('Could not find location; please enable location settings for your browser');
  }

  navigator.geolocation.getCurrentPosition(foundLocation, noLocation);
  $(function(){
    $("tr").on('click', function(e){
      var url = document.location.href;
      document.location.href = url + "/" + $(e.target).parent().find('td:first').data('id');
    });

  });
</script>